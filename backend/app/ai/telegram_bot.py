"""
Telegram Bot for Owner Notifications

Sends alerts and daily reports to the platform owner.
"""
import asyncio
import aiohttp
from typing import Optional, Dict, Any
from datetime import datetime
import json

from .config import ai_settings


class TelegramNotifier:
    """Send notifications to owner via Telegram"""

    def __init__(self):
        self.token = ai_settings.TELEGRAM_BOT_TOKEN
        self.chat_id = ai_settings.TELEGRAM_OWNER_CHAT_ID
        self.base_url = f"https://api.telegram.org/bot{self.token}"

    @property
    def is_configured(self) -> bool:
        return bool(self.token and self.chat_id)

    async def send_message(
        self,
        text: str,
        parse_mode: str = "HTML",
        disable_notification: bool = False
    ) -> Dict[str, Any]:
        """Send a message to the owner"""
        if not self.is_configured:
            return {"error": "Telegram not configured"}

        url = f"{self.base_url}/sendMessage"
        payload = {
            "chat_id": self.chat_id,
            "text": text,
            "parse_mode": parse_mode,
            "disable_notification": disable_notification
        }

        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload) as response:
                    return await response.json()
        except Exception as e:
            return {"error": str(e)}

    async def send_alert(
        self,
        title: str,
        message: str,
        level: str = "INFO",
        data: Optional[Dict] = None
    ):
        """Send an alert notification"""
        emoji_map = {
            "INFO": "â„¹ï¸",
            "WARNING": "âš ï¸",
            "ERROR": "âŒ",
            "CRITICAL": "ğŸš¨",
            "SUCCESS": "âœ…",
            "MONEY": "ğŸ’°"
        }
        emoji = emoji_map.get(level, "ğŸ“¢")

        text = f"{emoji} <b>{title}</b>\n\n{message}"

        if data:
            text += "\n\n<pre>" + json.dumps(data, ensure_ascii=False, indent=2)[:500] + "</pre>"

        text += f"\n\nğŸ• {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"

        return await self.send_message(text)

    async def send_new_signup_alert(
        self,
        tenant_name: str,
        tenant_email: str,
        plan: str = "FREE"
    ):
        """Alert when new tenant signs up"""
        await self.send_alert(
            title="KhÃ¡ch hÃ ng má»›i Ä‘Äƒng kÃ½!",
            message=f"<b>{tenant_name}</b>\nğŸ“§ {tenant_email}\nğŸ“¦ GÃ³i: {plan}",
            level="SUCCESS"
        )

    async def send_payment_alert(
        self,
        tenant_name: str,
        amount: float,
        invoice_id: str
    ):
        """Alert when payment received"""
        await self.send_alert(
            title="Thanh toÃ¡n má»›i!",
            message=f"<b>{tenant_name}</b>\nğŸ’µ {amount:,.0f} VND\nğŸ“„ Invoice: {invoice_id}",
            level="MONEY"
        )

    async def send_support_escalation(
        self,
        ticket_id: str,
        subject: str,
        user_email: str,
        conversation_summary: str
    ):
        """Alert when support escalated to human"""
        await self.send_alert(
            title="YÃªu cáº§u há»— trá»£ cáº§n xá»­ lÃ½",
            message=f"ğŸ« Ticket: {ticket_id}\nğŸ“§ User: {user_email}\n\n<b>Váº¥n Ä‘á»:</b> {subject}\n\n<b>TÃ³m táº¯t:</b>\n{conversation_summary[:500]}",
            level="WARNING"
        )

    async def send_error_alert(
        self,
        error_type: str,
        error_message: str,
        context: Optional[Dict] = None
    ):
        """Alert on system errors"""
        await self.send_alert(
            title=f"Lá»—i há»‡ thá»‘ng: {error_type}",
            message=error_message[:500],
            level="ERROR",
            data=context
        )

    async def send_daily_report(
        self,
        mrr: float,
        active_tenants: int,
        new_signups: int,
        churned: int,
        support_tickets: int,
        auto_resolved: int,
        uptime: float
    ):
        """Send daily business report"""
        report = f"""ğŸ“Š <b>BÃO CÃO NGÃ€Y {datetime.now().strftime('%d/%m/%Y')}</b>

ğŸ’° <b>Doanh thu</b>
â€¢ MRR: {mrr:,.0f} VND

ğŸ‘¥ <b>KhÃ¡ch hÃ ng</b>
â€¢ Active: {active_tenants}
â€¢ Má»›i: +{new_signups}
â€¢ Churn: -{churned}

ğŸ« <b>Support</b>
â€¢ Tickets: {support_tickets}
â€¢ AI resolved: {auto_resolved} ({auto_resolved/max(support_tickets,1)*100:.0f}%)

âš¡ <b>System</b>
â€¢ Uptime: {uptime:.2f}%

---
ğŸ¤– Auto-generated by 9log AI
"""
        await self.send_message(report)

    async def send_usage_alert(
        self,
        tenant_name: str,
        usage_percent: int,
        credits_used: int,
        credits_limit: int
    ):
        """Alert when tenant reaches usage threshold"""
        if usage_percent >= 100:
            level = "ERROR"
            title = "Tenant Ä‘Ã£ háº¿t quota!"
        elif usage_percent >= 80:
            level = "WARNING"
            title = "Tenant sáº¯p háº¿t quota"
        else:
            return  # Don't alert for low usage

        await self.send_alert(
            title=title,
            message=f"<b>{tenant_name}</b>\nğŸ“Š Sá»­ dá»¥ng: {usage_percent}%\nğŸ’³ {credits_used:,}/{credits_limit:,} credits",
            level=level
        )


# Singleton instance
_notifier: Optional[TelegramNotifier] = None


def get_telegram_notifier() -> TelegramNotifier:
    """Get Telegram notifier instance"""
    global _notifier
    if _notifier is None:
        _notifier = TelegramNotifier()
    return _notifier


# Convenience functions
async def notify_owner(title: str, message: str, level: str = "INFO"):
    """Quick function to notify owner"""
    notifier = get_telegram_notifier()
    await notifier.send_alert(title, message, level)


async def notify_error(error_type: str, error_message: str):
    """Quick function to notify error"""
    notifier = get_telegram_notifier()
    await notifier.send_error_alert(error_type, error_message)
